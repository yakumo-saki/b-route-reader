# End of Life

SA-M0が終売になり、設定用のアプリもストアから削除されたのでこのコードの役割も終わったと思われます。  
（もちろん、今使えているならそのまま使えますし、アプリもインストール済みなら大丈夫なはず）  

## アプリもないし、引っ越ししてしまった？ もう使い物にならない？

でも、SA-M0を捨てるのはちょっと待ってください。SA-M0は分解すると ROHM BP35A1 モジュールが入っています。
これは、単品で購入すると高額なモジュールです。 

* ブレイクアウト基盤 BP35A7A を組み合わることでRaspberry Pi や Arduinoと接続可能です。
* M5Stack用のBP35A1接続HATもあるようです。

これらによって引き続き消費電力を取得し続けることが可能です。  
捨ててしまうくらいなら分解して、このモジュールだけでも取り出しておくことをおすすめします。

# b-route-reader with SA-M0

Bルートのスマートメーターの値を読む。（SA-M0使用）
同一ネットワーク上のスマートメーターを探して、最初に見つけたメーターに対して値を読み込みます。

## 使い方

* 初回のみ `npm i` を実行
* `node echonet.js`

## 出力

`log/powerlog.log` にJSON形式で結果を出力します。純粋なJSONを追記しているだけなので最新の結果は最後の行に出力されます。
最新の結果を取り出すには `tail -n 1 log/powerdata.log` とすれば取り出せます。

なお、出力先は `config/log4js.json` で指定されているので変更することも可能です。

### JSON

```
// 整形済み。実際は改行等されていません。
{
  "datetime": "2021-04-08T01:39:16.429Z",
  "e1": "01",
  "e0": "0003cb19",
  "e7": "000002a8",
  "e8": "00140028",
  "delta_kwh": 24860.1,
  "now_w": 680,
  "now_R_amp": 2,
  "now_T_amp": 4,
  "now_total_amp": 6
}
```

| name | 内容 |
| ---- | ---- |
| datetime | 実行日時 |
| e1 | 0xE1 積算電力量単位 (生の値) |
| e0 | 0xE0 積算電力量計測値 (生の値) |
| e7 | 0xE7 瞬時電力計測値 (生の値) |
| e8 | 瞬時電流計測値 (生の値) |
| delta_kwh | 積算電力量（解釈済み） 単位：kwh |
| now_w | 瞬間電力値 単位：W |
| now_R_amp | R相の瞬間電力値 単位：A |
| now_T_amp | T相の瞬間電力値。単相2線式の場合常に0 単位：A |
| now_total_amp | 瞬間電力値合計 単位：A |


# 参照文献

https://echonet.jp/spec_g/ よりダウンロード可能。

## Echonet Lite 規格書

基本的なデータ構造等
## APPENDIX ECHONET機器オブジェクト詳細規定

`３．３．２５低圧スマート電力量メータクラス規定` スマートメーターのプロパティとその意味の定義
